module Malware;

@Alert(name='Malware',outID=1)
@Name('Malware')
@Enrich(dst="alert_severity",type="cmd",param="echo High")
@Enrich(dst="alert_type",type="cmd",param="echo Malware")
SELECT window(outcoming.*) as outcoming, window(incoming.*) as incoming, coalesce(outcoming.src_ip,incoming.dst_ip) as src_ip
        FROM suricata(
        (alert("signature").toString() LIKE "ET MALWARE%") 
	AND tags.contains("local")
	AND src_ip NOT IN (proxy_whitelist)).win:time(10 min) as outcoming
        FULL OUTER JOIN
        suricata(
        (alert("signature").toString() LIKE "ET MALWARE%"
        AND NOT tags.contains("local")).win:time(10 min) as incoming
        on outcoming.src_ip = incoming.dst_ip
GROUP BY outcoming.src_ip
HAVING count(*) >= 3
output first every 15 min;
